<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¸ªäººä¹¦æ¶</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <header class="app-header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">
            <i class="fa-solid fa-book"></i>
          </div>
          <div class="brand-text">
            <h1 class="title">ä¸ªäººä¹¦æ¶</h1>
            <p class="subtitle">ç®¡ç†ä½ çš„çŸ¥è¯†åº“</p>
          </div>
        </div>

        <section class="stats" aria-label="ç»Ÿè®¡ä¿¡æ¯">
          <div class="stat">
            <div class="stat-label">æ€»è—ä¹¦</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">å·²è¯»</div>
            <div class="stat-value" id="statRead">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">åœ¨è¯»</div>
            <div class="stat-value" id="statReading">0</div>
          </div>
          <div class="stat stat-storage" id="statStorage" title="æ•°æ®å­˜å‚¨æ–¹å¼">
            <div class="stat-label">å­˜å‚¨</div>
            <div class="stat-value" id="statStorageValue">-</div>
          </div>
        </section>
      </div>
    </header>

    <main class="container">
      <section class="controls" aria-label="ç­›é€‰ä¸æ“ä½œåŒº">
        <div class="controls-top">
          <div class="search-wrapper">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass search-icon"></i>
              <input
                type="text"
                id="searchInput"
                placeholder="æœç´¢ä¹¦åæˆ–ä½œè€…..."
                autocomplete="off"
                aria-label="æœç´¢ä¹¦ç±"
              />
              <button class="btn-clear-search" id="btnClearSearch" type="button" aria-label="æ¸…é™¤æœç´¢" hidden>
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

          <div class="right-actions">
            <button class="btn btn-primary" id="btnAddNew" type="button">
              <i class="fa-solid fa-plus"></i>
              æ–°å¢
            </button>
            <button class="btn btn-ghost" id="btnClearAll" type="button">
              <i class="fa-solid fa-trash-can"></i>
              æ¸…ç©ºå…¨éƒ¨
            </button>
          </div>
        </div>

        <div class="filters" role="tablist" aria-label="ç­›é€‰ä¹¦ç±">
          <button class="chip is-active" data-filter="all" type="button">
            å…¨éƒ¨
          </button>
          <button class="chip" data-filter="å·²è¯»" type="button">å·²è¯»</button>
          <button class="chip" data-filter="åœ¨è¯»" type="button">åœ¨è¯»</button>
          <button class="chip" data-filter="æƒ³è¯»" type="button">æƒ³è¯»</button>
          <button class="chip" data-filter="high" type="button">
            é«˜è¯„åˆ† 4+
          </button>
        </div>
      </section>

      <section class="shelf" aria-label="ä¹¦æ¶">
          <div class="shelf-head">
            <h2 class="section-title">ä¹¦æ¶</h2>
            <p class="section-desc" id="shelfHint">ç‚¹å‡»å¡ç‰‡æŒ‰é’®è¿›è¡Œç¼–è¾‘ã€åˆ é™¤æˆ–åˆ‡æ¢çŠ¶æ€</p>
          </div>

            <div class="empty" id="emptyState" hidden>
            <div class="empty-icon" aria-hidden="true">
              <i class="fa-regular fa-bookmark"></i>
            </div>
            <div class="empty-title" id="emptyTitle">æš‚æ— ä¹¦ç±</div>
            <div class="empty-desc" id="emptyDesc">ç‚¹å‡»ä¸Šæ–¹çš„"æ–°å¢"æŒ‰é’®æ·»åŠ ä½ çš„ç¬¬ä¸€æœ¬ä¹¦å§</div>
          </div>

          <div class="grid" id="bookGrid" aria-label="ä¹¦ç±åˆ—è¡¨"></div>
        </section>
      </section>

      <!-- å¼¹çª—é®ç½©å±‚ -->
      <div class="modal-overlay" id="modalOverlay" hidden>
      <div class="modal-container" id="modalContainer">
        <!-- ä¹¦ç±è¡¨å•å¼¹çª— -->
        <section class="form-card" id="formCard" aria-label="ä¹¦ç±è¡¨å•">
          <div class="form-head">
            <div>
              <h2 class="section-title" id="formTitle">æ·»åŠ ä¹¦ç±</h2>
              <p class="section-desc">å¡«å†™ä¿¡æ¯åä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“</p>
            </div>
            <button class="btn-close" id="btnCloseForm" type="button" aria-label="å…³é—­è¡¨å•">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <form id="bookForm" novalidate>
            <input type="hidden" id="bookId" />

            <div class="grid-2">
              <label class="field">
                <span class="field-label">ä¹¦å <span class="req">*</span></span>
                <input
                  id="title"
                  name="title"
                  type="text"
                  placeholder="ä¾‹å¦‚ï¼šä¸‰ä½“"
                  required
                  maxlength="100"
                  autocomplete="off"
                />
                <span class="field-error" data-error-for="title"></span>
              </label>

              <label class="field">
                <span class="field-label">ä½œè€… <span class="req">*</span></span>
                <input
                  id="author"
                  name="author"
                  type="text"
                  placeholder="ä¾‹å¦‚ï¼šåˆ˜æ…ˆæ¬£"
                  required
                  maxlength="60"
                  autocomplete="off"
                />
                <span class="field-error" data-error-for="author"></span>
              </label>
            </div>

            <label class="field">
              <span class="field-label">å°é¢å›¾ç‰‡ URLï¼ˆå¯é€‰ï¼‰</span>
              <input
                id="cover"
                name="cover"
                type="url"
                placeholder="https://example.com/cover.jpg"
                autocomplete="off"
              />
              <span class="field-help">ä¸å¡«å†™æˆ–åŠ è½½å¤±è´¥ä¼šæ˜¾ç¤ºé»˜è®¤ä¹¦ç±å›¾æ ‡</span>
            </label>

            <div class="grid-2">
              <label class="field">
                <span class="field-label">é˜…è¯»çŠ¶æ€</span>
                <select id="status" name="status">
                  <option value="æƒ³è¯»">æƒ³è¯»</option>
                  <option value="åœ¨è¯»">åœ¨è¯»</option>
                  <option value="å·²è¯»">å·²è¯»</option>
                </select>
              </label>

              <label class="field">
                <span class="field-label">è¯„åˆ†</span>
                <select id="rating" name="rating">
                  <option value="0">æœªè¯„åˆ†</option>
                  <option value="1">1 æ˜Ÿ</option>
                  <option value="2">2 æ˜Ÿ</option>
                  <option value="3">3 æ˜Ÿ</option>
                  <option value="4">4 æ˜Ÿ</option>
                  <option value="5">5 æ˜Ÿ</option>
                </select>
              </label>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" id="btnSubmit" type="submit">
                <i class="fa-solid fa-plus"></i>
                æ·»åŠ 
              </button>
              <button class="btn btn-ghost" id="btnCancelEdit" type="button" hidden>
                å–æ¶ˆç¼–è¾‘
              </button>
            </div>
          </form>

          <div class="toast" id="toast" role="status" aria-live="polite"></div>
        </section>

        <!-- ç¬”è®°ç¼–è¾‘å¼¹çª— -->
        <section class="form-card" id="notesCard" aria-label="ç¬”è®°ç¼–è¾‘" hidden>
          <div class="form-head">
            <div>
              <h2 class="section-title" id="notesTitle">ç¬”è®°</h2>
              <p class="section-desc" id="notesSubtitle">è®°å½•ä½ çš„é˜…è¯»å¿ƒå¾—å’Œæƒ³æ³•</p>
            </div>
            <button class="btn-close" id="btnCloseNotes" type="button" aria-label="å…³é—­ç¬”è®°">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="notes-content">
            <div class="book-info" id="notesBookInfo"></div>
            <label class="field">
              <span class="field-label">ç¬”è®°å†…å®¹</span>
              <textarea
                id="notesTextarea"
                placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„é˜…è¯»å¿ƒå¾—ã€æ‘˜å½•ã€æƒ³æ³•..."
                rows="12"
                maxlength="5000"
              ></textarea>
              <div class="field-footer">
                <span class="field-help">æ”¯æŒæœ€å¤š 5000 å­—</span>
                <span class="char-count" id="charCount">0 / 5000</span>
              </div>
            </label>
            <div class="form-actions">
              <button class="btn btn-primary" id="btnSaveNotes" type="button">
                <i class="fa-solid fa-floppy-disk"></i>
                ä¿å­˜ç¬”è®°
              </button>
              <button class="btn btn-ghost" id="btnShareBook" type="button">
                <i class="fa-solid fa-share-nodes"></i>
                åˆ†äº«è¿™æœ¬ä¹¦
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>


    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
      // Supabase é…ç½®ï¼ˆå†…è”åœ¨ HTML ä¸­ï¼Œç¡®ä¿éƒ¨ç½²æ—¶å¯ç”¨ï¼‰
      // æ³¨æ„ï¼šanon key æ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥å®‰å…¨åœ°æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­
      window.SUPABASE_CONFIG = {
        url: "https://vgwzodihcdkkareljztm.supabase.co",
        anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnd3pvZGloY2Rra2FyZWxqenRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTUwOTAsImV4cCI6MjA4NjM3MTA5MH0.PAw5RMC3kk3luG8xrupZWRZyoH7kVMd5yHqlXaOAVQ4"
      };
    </script>
    <script src="./config.js"></script>
    <script>
      // ç¡®ä¿ Supabase åº“å’Œé…ç½®åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
      (function initWhenReady() {
        console.log("ğŸ” æ£€æŸ¥ Supabase åˆå§‹åŒ–çŠ¶æ€...");
        console.log("  window.supabase:", typeof window.supabase);
        console.log("  window.SUPABASE_CONFIG:", typeof window.SUPABASE_CONFIG);
        console.log("  initSupabase function:", typeof initSupabase);
        
        // æ£€æŸ¥ Supabase åº“æ˜¯å¦åŠ è½½
        if (typeof window.supabase === "undefined") {
          console.log("â³ Supabase åº“è¿˜æœªåŠ è½½ï¼Œç­‰å¾…...");
          setTimeout(initWhenReady, 50);
          return;
        }
        
        console.log("âœ… Supabase åº“å·²åŠ è½½");
        
        // æ£€æŸ¥ config.js æ˜¯å¦åŠ è½½ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼Œä½¿ç”¨ localStorageï¼‰
        if (typeof initSupabase === "function") {
          console.log("âœ… initSupabase å‡½æ•°å­˜åœ¨ï¼Œå¼€å§‹åˆå§‹åŒ–...");
          try {
            const result = initSupabase();
            if (result) {
              console.log("âœ… Supabase åˆå§‹åŒ–æˆåŠŸ");
            } else {
              console.warn("âš ï¸ Supabase åˆå§‹åŒ–è¿”å› null");
              window.supabase = null;
            }
          } catch (err) {
            console.error("âŒ Supabase åˆå§‹åŒ–å¤±è´¥:", err);
            console.error("é”™è¯¯å †æ ˆ:", err.stack);
            window.supabase = null;
          }
        } else {
          // config.js æœªåŠ è½½ï¼Œç›´æ¥ä½¿ç”¨ localStorage
          console.warn("âš ï¸ config.js æœªæ‰¾åˆ°æˆ– initSupabase å‡½æ•°ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ localStorage");
          console.log("å°è¯•ä½¿ç”¨ window.SUPABASE_CONFIG ç›´æ¥åˆå§‹åŒ–...");
          
          // å°è¯•ç›´æ¥ä½¿ç”¨ window.SUPABASE_CONFIG åˆå§‹åŒ–
          if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url && window.SUPABASE_CONFIG.anonKey) {
            try {
              console.log("ğŸ”„ ä½¿ç”¨ window.SUPABASE_CONFIG ç›´æ¥åˆå§‹åŒ– Supabase...");
              window.supabase = window.supabase.createClient(
                window.SUPABASE_CONFIG.url,
                window.SUPABASE_CONFIG.anonKey
              );
              console.log("âœ… ç›´æ¥åˆå§‹åŒ– Supabase æˆåŠŸ");
            } catch (err) {
              console.error("âŒ ç›´æ¥åˆå§‹åŒ–å¤±è´¥:", err);
              window.supabase = null;
            }
          } else {
            window.supabase = null;
          }
        }
      })();
    </script>
    <script src="./app.js"></script>
    <script>
      // ç¡®ä¿åº”ç”¨å·²åˆå§‹åŒ– - åŒé‡æ£€æŸ¥
      (function checkInit() {
        console.log("ğŸ“‹ é¡µé¢åŠ è½½æ£€æŸ¥è„šæœ¬æ‰§è¡Œ");
        console.log("ğŸ“‹ DOM çŠ¶æ€:", document.readyState);
        console.log("ğŸ“‹ æ£€æŸ¥å…³é”®å…ƒç´ :", {
          btnAddNew: !!document.getElementById("btnAddNew"),
          modalOverlay: !!document.getElementById("modalOverlay"),
          formCard: !!document.getElementById("formCard"),
          appJsLoaded: typeof window.init !== "undefined"
        });
        
        // å¦‚æœ app.js æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–ï¼Œå°è¯•æ‰‹åŠ¨è§¦å‘
        setTimeout(function() {
          const btn = document.getElementById("btnAddNew");
          if (btn && !btn.onclick) {
            console.warn("âš ï¸ æ–°å¢æŒ‰é’®æ²¡æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œå°è¯•æ‰‹åŠ¨ç»‘å®š");
            btn.addEventListener("click", function(e) {
              e.preventDefault();
              console.log("ğŸ”§ æ‰‹åŠ¨ç»‘å®šçš„æ–°å¢æŒ‰é’®è¢«ç‚¹å‡»");
              const overlay = document.getElementById("modalOverlay");
              const formCard = document.getElementById("formCard");
              if (overlay && formCard) {
                overlay.hidden = false;
                formCard.hidden = false;
                document.body.style.overflow = "hidden";
                console.log("âœ… æ‰‹åŠ¨æ˜¾ç¤ºè¡¨å•");
              } else {
                console.error("âŒ æ— æ³•æ‰¾åˆ°å¼¹çª—å…ƒç´ ");
              }
            });
          }
        }, 1000);
      })();
    </script>
  </body>
</html>

