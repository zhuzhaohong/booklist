<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>个人数字书架</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <header class="app-header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">
            <i class="fa-solid fa-book"></i>
          </div>
          <div class="brand-text">
            <h1 class="title">个人数字书架</h1>
            <p class="subtitle">管理你的阅读清单：想读、在读、已读与评分</p>
          </div>
        </div>

        <section class="stats" aria-label="统计信息">
          <div class="stat">
            <div class="stat-label">总藏书</div>
            <div class="stat-value" id="statTotal">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">已读</div>
            <div class="stat-value" id="statRead">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">在读</div>
            <div class="stat-value" id="statReading">0</div>
          </div>
          <div class="stat stat-storage" id="statStorage" title="数据存储方式">
            <div class="stat-label">存储</div>
            <div class="stat-value" id="statStorageValue">-</div>
          </div>
        </section>
      </div>
    </header>

    <main class="container">
      <section class="controls" aria-label="筛选与操作区">
        <div class="controls-top">
          <div class="search-wrapper">
            <div class="search-box">
              <i class="fa-solid fa-magnifying-glass search-icon"></i>
              <input
                type="text"
                id="searchInput"
                placeholder="搜索书名或作者..."
                autocomplete="off"
                aria-label="搜索书籍"
              />
              <button class="btn-clear-search" id="btnClearSearch" type="button" aria-label="清除搜索" hidden>
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>

          <div class="right-actions">
            <button class="btn btn-primary" id="btnAddNew" type="button">
              <i class="fa-solid fa-plus"></i>
              新增
            </button>
            <button class="btn btn-ghost" id="btnClearAll" type="button">
              <i class="fa-solid fa-trash-can"></i>
              清空全部
            </button>
          </div>
        </div>

        <div class="filters" role="tablist" aria-label="筛选书籍">
          <button class="chip is-active" data-filter="all" type="button">
            全部
          </button>
          <button class="chip" data-filter="已读" type="button">已读</button>
          <button class="chip" data-filter="在读" type="button">在读</button>
          <button class="chip" data-filter="想读" type="button">想读</button>
          <button class="chip" data-filter="high" type="button">
            高评分 4+
          </button>
        </div>
      </section>

      <section class="shelf" aria-label="书架">
          <div class="shelf-head">
            <h2 class="section-title">书架</h2>
            <p class="section-desc" id="shelfHint">点击卡片按钮进行编辑、删除或切换状态</p>
          </div>

            <div class="empty" id="emptyState" hidden>
            <div class="empty-icon" aria-hidden="true">
              <i class="fa-regular fa-bookmark"></i>
            </div>
            <div class="empty-title" id="emptyTitle">暂无书籍</div>
            <div class="empty-desc" id="emptyDesc">点击上方的"新增"按钮添加你的第一本书吧</div>
          </div>

          <div class="grid" id="bookGrid" aria-label="书籍列表"></div>
        </section>
      </section>

      <!-- 弹窗遮罩层 -->
      <div class="modal-overlay" id="modalOverlay" hidden>
      <div class="modal-container" id="modalContainer">
        <!-- 书籍表单弹窗 -->
        <section class="form-card" id="formCard" aria-label="书籍表单">
          <div class="form-head">
            <div>
              <h2 class="section-title" id="formTitle">添加书籍</h2>
              <p class="section-desc">填写信息后保存到云端数据库</p>
            </div>
            <button class="btn-close" id="btnCloseForm" type="button" aria-label="关闭表单">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <form id="bookForm" novalidate>
            <input type="hidden" id="bookId" />

            <div class="grid-2">
              <label class="field">
                <span class="field-label">书名 <span class="req">*</span></span>
                <input
                  id="title"
                  name="title"
                  type="text"
                  placeholder="例如：三体"
                  required
                  maxlength="100"
                  autocomplete="off"
                />
                <span class="field-error" data-error-for="title"></span>
              </label>

              <label class="field">
                <span class="field-label">作者 <span class="req">*</span></span>
                <input
                  id="author"
                  name="author"
                  type="text"
                  placeholder="例如：刘慈欣"
                  required
                  maxlength="60"
                  autocomplete="off"
                />
                <span class="field-error" data-error-for="author"></span>
              </label>
            </div>

            <label class="field">
              <span class="field-label">封面图片 URL（可选）</span>
              <input
                id="cover"
                name="cover"
                type="url"
                placeholder="https://example.com/cover.jpg"
                autocomplete="off"
              />
              <span class="field-help">不填写或加载失败会显示默认书籍图标</span>
            </label>

            <div class="grid-2">
              <label class="field">
                <span class="field-label">阅读状态</span>
                <select id="status" name="status">
                  <option value="想读">想读</option>
                  <option value="在读">在读</option>
                  <option value="已读">已读</option>
                </select>
              </label>

              <label class="field">
                <span class="field-label">评分</span>
                <select id="rating" name="rating">
                  <option value="0">未评分</option>
                  <option value="1">1 星</option>
                  <option value="2">2 星</option>
                  <option value="3">3 星</option>
                  <option value="4">4 星</option>
                  <option value="5">5 星</option>
                </select>
              </label>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" id="btnSubmit" type="submit">
                <i class="fa-solid fa-plus"></i>
                添加
              </button>
              <button class="btn btn-ghost" id="btnCancelEdit" type="button" hidden>
                取消编辑
              </button>
            </div>
          </form>

          <div class="toast" id="toast" role="status" aria-live="polite"></div>
        </section>

        <!-- 笔记编辑弹窗 -->
        <section class="form-card" id="notesCard" aria-label="笔记编辑" hidden>
          <div class="form-head">
            <div>
              <h2 class="section-title" id="notesTitle">笔记</h2>
              <p class="section-desc" id="notesSubtitle">记录你的阅读心得和想法</p>
            </div>
            <button class="btn-close" id="btnCloseNotes" type="button" aria-label="关闭笔记">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="notes-content">
            <div class="book-info" id="notesBookInfo"></div>
            <label class="field">
              <span class="field-label">笔记内容</span>
              <textarea
                id="notesTextarea"
                placeholder="在这里记录你的阅读心得、摘录、想法..."
                rows="12"
                maxlength="5000"
              ></textarea>
              <div class="field-footer">
                <span class="field-help">支持最多 5000 字</span>
                <span class="char-count" id="charCount">0 / 5000</span>
              </div>
            </label>
            <div class="form-actions">
              <button class="btn btn-primary" id="btnSaveNotes" type="button">
                <i class="fa-solid fa-floppy-disk"></i>
                保存笔记
              </button>
              <button class="btn btn-ghost" id="btnShareBook" type="button">
                <i class="fa-solid fa-share-nodes"></i>
                分享这本书
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>


    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
      // Supabase 配置（内联在 HTML 中，确保部署时可用）
      // 注意：anon key 是公开的，可以安全地暴露在前端代码中
      window.SUPABASE_CONFIG = {
        url: "https://vgwzodihcdkkareljztm.supabase.co",
        anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnd3pvZGloY2Rra2FyZWxqenRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3OTUwOTAsImV4cCI6MjA4NjM3MTA5MH0.PAw5RMC3kk3luG8xrupZWRZyoH7kVMd5yHqlXaOAVQ4"
      };
    </script>
    <script src="./config.js"></script>
    <script>
      // 确保 Supabase 库和配置加载完成后再初始化
      (function initWhenReady() {
        // 检查 Supabase 库是否加载
        if (typeof window.supabase === "undefined") {
          setTimeout(initWhenReady, 50);
          return;
        }
        
        // 检查 config.js 是否加载（可能不存在，使用 localStorage）
        if (typeof initSupabase === "function") {
          try {
            initSupabase();
          } catch (err) {
            console.warn("⚠️ Supabase 初始化失败，将使用 localStorage:", err);
            window.supabase = null;
          }
        } else {
          // config.js 未加载，直接使用 localStorage
          console.warn("⚠️ config.js 未找到，将使用 localStorage");
          window.supabase = null;
        }
      })();
    </script>
    <script src="./app.js"></script>
  </body>
</html>

